---
title: "KHN Data"
output:
  html_document:
    df_print: paged
---
Final project copy!

Run packages
```{r}
#install.packages("tidyverse")
library("tidyverse")
#install.packages("rio")
library("rio")
#install.packages("pacman")
library("pacman")
#install.packages("rmarkdown")
library("rmarkdown")
library("dplyr")
#install.packages("gghighlight")
library(gghighlight)
library(plotly)
```

```{r}
getwd()
```


Upload data and create a dataframe called khn
```{r}
download.file("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/05-local-health-departments-detail.csv", "05-local-health-departments-detail.csv")
khn <- rio::import("05-local-health-departments-detail.csv")
```

Create a new df called nc that filters just for nc
```{r}
nc <- khn %>%
  filter(state_code == "NC")
```

Just take the categories I want and filter out counties without fte data
```{r}
summary_nc <- nc %>%
  select(`year`, `lhd_name`, `lhd_area_type`, `population`, `fte`, `fte_per_100000`, `population`) %>%
  filter(fte != "NA")
```

Just show me single counties
```{r}
single_counties_summary_nc <-
  summary_nc %>%
  filter(lhd_area_type == "single county") 

single_counties_summary_nc
```

Which lhd_names are only listed once? This may indicate that they merged into a multi county hd
```{r}
single_counties_summary_nc %>%
  group_by(lhd_name) %>%
  summarize(n()) 

#Bertie
#Granville
#McDowell
#Mitchell
#Polk
#Rutherford
#Vance
#Yancey
```

Fte_per_100000 is fte per capita. Create a new df that just has the year, lhd name, and fte per capita
```{r}
fte_per_capita <- single_counties_summary_nc %>%
  select(`year`, `lhd_name`, `fte_per_100000`, `fte`, `population`)

```

Find the avg fte per capita 
```{r}
fte_per_capita %>%
  group_by(lhd_name) %>%
  summarise(Avg_fte_per_100000 = mean(fte_per_100000)) %>%
  select(lhd_name, Avg_fte_per_100000) %>%
  arrange(desc(Avg_fte_per_100000))

```
Find the avg fte from 2009-2017
```{r}
years <- c("2009", "2011", "2013", "2015", "2017")
nine_seventeen_single_counties_summary_nc <- single_counties_summary_nc %>% filter(year == years)

nc_avg_fte <- nine_seventeen_single_counties_summary_nc %>%
  filter(year == c("2009", "2011", "2013", "2015", "2017")) %>%
  group_by(lhd_name) %>%
  mutate(Avg_fte = mean(fte)) %>%
  arrange(desc(Avg_fte))
```

From 2003-2017, what is the % change in fte per capita for each single lhd? I chose 2003 because I don't think many lhds have data from 1999
```{r}
fte_per_capita %>%
  filter(year %in% c('2003', '2017')) %>%
  # USE THE id_cols argument and set the value to "evertyhing but the set of columns that contains fte and population". This allows each row to be unique to the lhd_name rather than lhd_name + fte + population.
  pivot_wider(id_cols = -c(fte,population), names_from = year, values_from = fte_per_100000) %>%
  # DONT NEED NEXT LINE - RT
 # group_by(lhd_name) %>%
  mutate(pct_change = 100 * ((`2017` - `2003`)) / `2003`) %>%
  arrange(desc(pct_change))
 
```

% change in fte from 2003-2017 
```{r}
fte_per_capita %>%
  filter(year %in% c('2003', '2017')) %>%
  # USE THE id_cols argument and set the value to "evertyhing but the set of columns that contains fte and population". This allows each row to be unique to the lhd_name rather than lhd_name + fte + population.
  pivot_wider(id_cols = -c(fte_per_100000,population), names_from = year, values_from = fte) %>%
  # DONT NEED NEXT LINE - RT
 # group_by(lhd_name) %>%
  mutate(pct_change = 100 * ((`2017` - `2003`)) / `2003`) %>%
  arrange(desc(pct_change))
```

Highest and lowest fte per capita and fte in 2017
```{r}
fte_per_capita %>%
  filter(year == "2017") %>%
  arrange(desc(fte_per_100000))

fte_per_capita %>%
  filter(year == "2017") %>%
  arrange(fte)
```

Jones County
```{r}
jones <- single_counties_summary_nc %>%
  filter(lhd_name == "Jones County Health Department") %>%
  select(`year`, `population`, `fte`, `fte_per_100000`)

#What happened in 2005?
```

Scatterplot (x: population, y: employees per capita)
```{r}
ggplot(fte_per_capita, aes(x=population, y=fte_per_100000)) + 
  geom_point(size= 1) +
   facet_wrap(~year, ncol=4) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  gghighlight(fte_per_100000 > 500) +
  labs(title = "FTE Per Capita and Population Over Time", x = "Population", y = "Employees Per Capita")
```

vector of average fte from 2003-
```{r}

```


line chart #1: fte change over time (X: year, y: fte)
```{r}
ggplot(nc_avg_fte, aes(x=year, y=fte)) + #VECTOR IN PLACE OF FTE
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  labs(title = "Average FTE Change Over Time", y ="Number of Employees", x = "Population")
```

line chart #2: X: year, y: fte per capita change over time
```{r}
ggplot(fte_per_capita, aes(x=population, y=fte_per_100000)) + 
  geom_line() +
  facet_wrap(~year, ncol=4) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
   labs(title = "FTE Per Capita Change Over Time", y ="Number of Employees", x = "Population")
```

Jones County fte per capita and fte change over time
```{r}
#ggplot(jones, aes(x=year, y=fte_per_100000)) + 
 # geom_line() +
  # labs(title = "Jones County: FTE Per Capita Change Over Time", y ="Employees Per Capita", x = "Population")

Jones_graph_fte_pc <- plot_ly(jones, x = ~year, y = ~fte_per_100000, type = 'scatter', mode = 'lines')

Jones_graph_fte_pc <- Jones_graph_fte_pc %>%
  layout(title = "Title placeholder", xaxis = list(title = "Year"), yaxis = list(title = "FTE Per Capita"))

Jones_graph_fte_pc
```

*From 2011 to reflect policy shift after Republican win


2009-2017 fte per capita change over time
```{r}

```


