---
title: "Analysis and Charts of LHD expenditure data"
author: "Rachel Crumpler"
output: html_notebook
---

```{r}
#Install packages
library(dplyr)
library(tidyverse)
```

#Importing compiled expenditure data from Google Sheets
```{r}
#install.packages("gsheet")
library(gsheet)
CompiledLHDExpenditures <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1Zc10pam92Y1218F90eXn9ri7-a4GQI1vhzING33nNSI/edit#gid=0")
```


#Quick look at column types
```{r}
str(CompiledLHDExpenditures)
```

#Sorting from least expenditures to greatest
```{r}
CompiledLHDExpendituresSorted <- arrange(CompiledLHDExpenditures, desc(expenditures))
```
Mecklenburg and Guilford have highest expenditures
Jones, Madison and Green have lowest expenditures

#Min, median, mean, and max expenditure values across counties
```{r}
CompiledLHDExpenditures %>% 
  summarise(
  LowestExpenditure= min(expenditures, na.rm=TRUE),
  Median=median(expenditures, na.rm=TRUE),
  Mean=mean(expenditures, na.rm=TRUE),
  HighestExpenditure=max(expenditures, na.rm=TRUE)
  )
```
Highest= Mecklenburg 2019
Lowest= Jones 2007

#Finding how many counties are greater than mean expenditure value
```{r}
CompiledLHDExpenditures %>%
  filter(expenditures>mean(expenditures, na.rm=TRUE))
```
189 counties greater than mean expenditures

#Min, median, mean, and max per capita spending values across counties
```{r}
CompiledLHDExpenditures %>% 
  summarise(
  LowestCapita= min(per_capita_spending, na.rm=TRUE),
  Median=median(per_capita_spending, na.rm=TRUE),
  Mean=mean(per_capita_spending, na.rm=TRUE),
  HighestCapita=max(per_capita_spending, na.rm=TRUE)
  )
```
Lowest= Rowan County 1999
Highest= Franklin County 2007

#Sorting from greatest to least of per capita spending
```{r}
PerCapitaSpendingSorted <- arrange(CompiledLHDExpenditures, desc(per_capita_spending))
```
-Franklin County consistently ranks at top in per captia spending with >$250
-Hyde and Dare counties also ranked at top in per capita spending
-Rowan and Yadkin counties rank at bottom in per capita spending <$37

#Finding how many counties are greater than mean per capita spending value
```{r}
CompiledLHDExpenditures %>%
  filter(per_capita_spending>mean(per_capita_spending, na.rm=TRUE))
```

#Analyzing expenditure data by year
```{r}
CompiledLHDExpenditures %>%
  group_by(year)%>%
  summarise(
    Mean=mean(expenditures, na.rm=TRUE),
    Median=median(expenditures, na.rm=TRUE),
    SumTotal= sum(expenditures, na.rm=TRUE),
    Total= n()
  )
```
SumTotal= Total expenditures of all counties for that year
Total= Number of counties we have data for

-Median annual expenditures have stayed in the 5,300,000-6,000,000 range from 2007-2020

***Deceiving to look at sum total going up when it is because we have more counties in later years

#Analyzing per capita spending by year
```{r}
CompiledLHDExpenditures %>%
  group_by(year)%>%
  summarise(
    Mean=mean(per_capita_spending, na.rm=TRUE),
    Median=median(per_capita_spending, na.rm=TRUE),
    Min=min(per_capita_spending, na.rm = TRUE),
    Max=max(per_capita_spending, na.rm= TRUE),
    Total= n()
  )
```
Per capita spending has stayed fairly stable over the past 10 years. Spending grew about $20 from 2000 to 2006. Spending has hovered around $68 since 2006

-2020 Median= $67
-2019 Median= $69
-2018 Median= $67


#Looking only at 2019 data
```{r}
Data2019 <- CompiledLHDExpenditures %>%
  filter(year == "2019") %>%
  arrange(desc(per_capita_spending))
```
Franklin County highest= $254
Yadkin County lowest= $34


#Closer look at Granville-Vance Health District
*This code can be used to look specifically at other counties of interest
```{r}
CompiledLHDExpenditures %>%
  filter(county_name == "Granville & Vance") %>%
  select(year, expenditures, per_capita_spending) %>%
  mutate(
    Median=median(expenditures),
    Mean=mean(expenditures),
    MedianCapita=median(per_capita_spending),
    MeanCapita=mean(per_capita_spending)
  )
```
*4 mutated columns are not done by year, they represent the value for the county over the years

-Granville-Vance expenditures and per capita spending has gone up gradually over the years



#Closer look at Catawba
```{r}
CompiledLHDExpenditures %>%
  filter(county_name == "Catawba") %>%
  select(year, expenditures, per_capita_spending) %>%
  mutate(
    Median=median(expenditures),
    Mean=mean(expenditures),
    MedianCapita=median(per_capita_spending),
    MeanCapita=mean(per_capita_spending)
  )
```
Catawba County has seen their per capita spending decline since 2011. It has decreased about $20 over that period.
2019 value of $53.84 lower than Median for 2019 of $69.

---------------------------------------------------
CHARTS
*They need work, formatting got messed up

#Loading graph packages
```{r}
library("viridis")
#install.packages("hrbrthemes")
library("hrbrthemes")
library("ggplot2")
```

#Making line graph of each individual LHD
```{r}
CompiledLHDExpenditures %>%
  ggplot( aes(x=year, y=expenditures, group=lhd_name, fill=lhd_name)) +
    geom_line() +
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position="none") +
    ggtitle("Trends in LHD Expenditures") +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      plot.title = element_text(size=14)
    ) +
    facet_wrap(~lhd_name)
```
#Making area chart of each individual LHD
```{r}
CompiledLHDExpenditures %>%
  ggplot( aes(x=year, y=expenditures, group=lhd_name, fill=lhd_name)) +
    geom_area() +
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position="none") +
    ggtitle("Trends in LHD Expenditures") +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      plot.title = element_text(size=14)
    ) +
    facet_wrap(~lhd_name)
```

#Isolating some of the LHDs for more specific line chart comparison
```{r}
linegraph <- CompiledLHDExpenditures %>% 
  filter(county_name %in% c("Swain","Jones", "Catawba", "Hyde", "Madison", "Mecklenburg"))

# Plot
linegraph %>%
  ggplot( aes(x=year, y=expenditures, group=lhd_name, color=lhd_name)) +
    geom_line() +
    scale_color_viridis(discrete = TRUE) +
    theme(
      legend.position="none",
      plot.title = element_text(size=14)
    ) +
    ggtitle("Trends of LHD expenditures") +
    theme_ipsum()

```


#This graph compares some of the LHD expenditures (can be adjusted for when we find counties we want to put next to each other for closer comparison)
```{r}
linegraph <- CompiledLHDExpenditures %>% 
  filter(county_name %in% c("Swain","Jones", "Catawba", "Hyde", "Madison", "Mecklenburg"))

# Plot
linegraph %>%
  ggplot(aes(x=year, y=expenditures, group=lhd_name, color=lhd_name)) +
    geom_line() +
    scale_color_viridis(discrete = TRUE) +
    theme(
      legend.position="none",
      plot.title = element_text(size=14), 
      axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    ggtitle("Comparing LHD Expenditures") +
    theme_ipsum()+
    facet_wrap(~lhd_name)
```



