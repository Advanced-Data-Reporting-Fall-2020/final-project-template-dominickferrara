---
title: "maps"
author: "Rachel Crumpler"
date: "10/27/2020"
output: html_document
---
Loading packages
```{r}
pacman::p_load(leaflet, glue, dplyr, sf, tmap, tmaptools, tidycensus, ggmap, htmltools,  htmlwidgets)  

pacman::p_load_gh(c("walkerke/tigris", "bhaskarvk/leaflet.extras")) 
```

Downloading shapefile of NC counties
```{r}
options(tigris_use_cache = TRUE)
nc_counties <- counties("NC")
```


Loading our health department data
```{r}
library(gsheet)
AllHealthDepartments <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1Tp6E7I3lguVumOMuFyoJJQ5naTroHmkeXqnXXqvq1cI/edit#gid=0")
```

Renaming column so name is consistent with health data column name so data frames can be joined
```{r}
nc_counties<- dplyr::rename(nc_counties, county_name = NAME) 
```


Joining NC counties shapefile with our health department data
```{r}
library(raster)

# merge on common variable, here called 'key'
county_map <- merge(nc_counties, AllHealthDepartments, by="county_name")

```



******NEED TO NARROW DOWN WHAT DATA SHOULD BE USED HERE

SHOULD IT BE THE AVERAGE OF ALL YEARS WE HAVE PER COUNTY
AVERAGE FROM 2009-2019
OR SHOULD I DO A FACETED GRAPH SHOWING 2009 LEVEL OF EXPENDITURES VS 2019 EXPENDITURES
```{r}
tmap_mode("view")
tm_shape(county_map) +
  tm_fill("expenditures",title="Average Expenditures from 2009-2019 per county",breaks=c(0,5000000,10000000,15000000,20000000,25000000,30000000, 80000000),palette="YlOrBr")  +
  tm_borders() +
  tm_layout(title = "Custom Breaks Map", title.position = c("right","bottom"))
```



Map filled by expenditure data
***Need to fix the missing county outlines
```{r}
tm_shape(county_map) +
  tm_polygons(col= "expenditures", id="county_name", palette="Greens") + 
  labs (title= "Expenditure Spending Across State") 
   
```

Map filled in with per capita data
***Need to fix the missing county outlines
```{r}
tm_shape(county_map) +
  tm_polygons(col= "per_capita_spending", id="county_name", palette="Greens")
```



Joining NC counties shapefile with our 2019 health department data
```{r}
library(raster)

# merge on common variable, here called 'key'
county_map2019 <- merge(nc_counties, Data2019, by="county_name")

```

Map showing range of 2019 expenditures for county data we have
```{r}
tm_shape(county_map2019) +
  tm_polygons(col= "expenditures", id="county_name", palette="Greens")
```

Map showing range of 2019 per capita spending for counties we have
```{r}
tm_shape(county_map2019) +
  tm_polygons(col= "per_capita_spending", id="county_name")
```

MAKE A MAP SHOWING PERCENT CHANGE

Loading in the code of data frame with percent change column
```{r}
ExpenditurePctChange <- CompiledLHDExpenditures %>%
  filter(year %in% c('2009', '2019')) %>%
  pivot_wider(id_cols = -c(per_capita_spending,population), names_from = year, values_from = expenditures) %>%
  mutate(expenditure_change= (`2019` - `2009`),
    pct_change = 100 * ((`2019` - `2009`)) / `2009`) %>%
  arrange(desc(pct_change))
```

Merging shapefile and data
```{r}
# merge on common variable, here called 'key'
pct_map <- merge(nc_counties, ExpenditurePctChange, by="county_name")
```

Creating map showing percent change
```{r}
tm_shape(pct_map) +
  tm_fill("pct_change",title="Percent Change in Health Department Expenditures from 2009-2019",palette="YlOrBr")  +
  tm_borders() +
  tm_layout(title = "Custom Breaks Map", title.position = c("right","bottom"))
```


