---
title: "rt201110"
author: "Ryan Thornburg"
date: "11/10/2020"
output: html_document
---

```{r}
nc_county_by_year <- CompiledLHDExpenditures %>%
  filter(year >=2010, year<=2018) %>%
  pivot_wider(id_cols = county_name, names_from = year, values_from = per_capita_spending, names_prefix = "year") %>%
  arrange(county_name)
  
```

```{r}
ggplotly(
  ggplot(filter(CompiledLHDExpenditures,year>=2010, year<=2019),
         aes(x=year, 
             y=per_capita_spending, 
             group=lhd_name, 
             color=lhd_name)) +
    geom_line() +
    scale_y_continuous()+
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position="none") +
    ggtitle("Trends in Health Department Expenditures") +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      plot.title = element_text(size=14)
    )
)
```


Franklin, Hyde, Dare, and Martin-Tyrell-Washington spend far more per person than any others.

```{r}
ggplotly(
  ggplot(filter(CompiledLHDExpenditures,year>=2010, year<=2019),
         aes(x=year, 
             y=population, 
             group=lhd_name, 
             color=lhd_name)) +
    geom_line() +
    scale_y_continuous()+
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position="none") +
    ggtitle("Trends in Health Department Expenditures") +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      plot.title = element_text(size=14)
    )
)
```


```{r}

state_public_health_agencies <- read_csv("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/01-state-public-health-agencies.csv")

state_local_government_spending <- read_csv("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/02-state-local-government-spending.csv")

county_local_government_spending <- read_csv("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/03-county-local-government-spending.csv")

local_health_departments_total_by_state <- read_csv("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/04-local-health-departments-total-by-state.csv")


local_health_departments_detail <- read_csv("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/05-local-health-departments-detail.csv", 
    col_types = cols(fips_place = col_character(), 
        fips_counties = col_character(), 
        lhd_note = col_character()))



```

Trying to replicate this claim: "Since 2010, spending for state public health departments has dropped by 16% per capita."

```{r}
state_public_health_agencies %>% 
  filter(year>=2010) %>%
  group_by(year) %>%
  summarize(total = sum(expenditures_infl_per_capita))
  
```

That math doesn't look right. Let's look for missing data.
```{r}
state_public_health_agencies %>% 
  filter(year>=2010, is.na(expenditures_infl_per_capita))
```
They have 104 state-year combinations of missing data.

Oh, they excluded Missouri, Michigan, Texas and Wyoming for percent change in expenditures from 2010 to 2018, because "do not have comparable data."

```{r}
state_public_health_agencies %>% 
  filter(year>=2010, year<=2019, !(state_code %in% c("MI","TX","MO","WY"))) %>%
  group_by(year) %>%
  summarize(total = sum(expenditures_infl_per_capita))
```
That's a 13% decrease when adjusted for inflation

```{r}
state_public_health_agencies %>% 
  filter(year>=2010, year<=2018, !(state_code %in% c("MI","TX","MO","WY"))) %>%
  group_by(year) %>%
  summarize(total = sum(expenditures_infl_per_capita)) %>%
  pivot_wider(names_from = year, values_from = total, names_prefix="year") %>%
  mutate(pct_change = (year2018-year2010)/year2010)
```
It's actually up, when adjusted for inflation.


Did they try to do it with 2019?
```{r}
state_public_health_agencies %>% 
  filter(year==2019, is.na(expenditures_infl_per_capita))
```
No. They don't have any expenditure data from 2019.




OK... well, let's look at local... 
```{r}
state_local_government_spending %>%
  group_by(year) %>%
  count()
  
```
THIS IS ONLY FOR 2017.


```{r}
local_health_departments_total_by_state %>%
  group_by(state_code) %>%
  count()
```
Only 7 states, and even then not for all years. 

```{r}
local_health_departments_total_by_state %>%
  filter(year>=2010, year<=2018) %>%
  group_by(year) %>%
  summarize(total = sum(expenditures_infl_per_capita)) %>%
  pivot_wider(names_from = year, values_from = total, names_prefix="year") %>%
  mutate(pct_change = (year2018-year2010)/year2010)
```

What the heck? This is only a 5% decrease.


```{r}
local_health_departments_total_by_state %>%
  filter(year>=2010, year<=2018) %>%
  pivot_wider(id_cols = state_code, names_from = year, values_from = expenditures_infl_per_capita, names_prefix="year")
```
```{r}
local_health_departments_total_by_state %>%
  filter(year>=2010, year<=2018, state_code %in% c("FL","KY","MN","OH")) %>%
  group_by(year) %>%
  summarize(total = sum(expenditures_infl_per_capita)) %>%
  pivot_wider(names_from = year, values_from = total, names_prefix="year") %>%
  mutate(pct_change = (year2018-year2010)/year2010)
```


Well, the use "median per capita expenditures among LHDs" in the NACCHO report, so maybe that's how they calculated decline for state agencies.

```{r}
state_public_health_agencies %>% 
  filter(year>=2010, year<=2018, !(state_code %in% c("MI","TX","MO","WY"))) %>%
  group_by(year) %>%
  summarize(median = median(expenditures_infl_per_capita)) %>%
  pivot_wider(names_from = year, values_from = median, names_prefix="year") %>%
  mutate(pct_change = (year2018-year2010)/year2010)
```

That's an 18% decrease.


Maybe they used state average... 

```{r}
state_public_health_agencies %>% 
  filter(year>=2010, year<=2018, !(state_code %in% c("MI","TX","MO","WY"))) %>%
  group_by(year) %>%
  summarize(avg = mean(expenditures_infl_per_capita)) %>%
  pivot_wider(names_from = year, values_from = avg, names_prefix="year") %>%
  mutate(pct_change = (year2018-year2010)/year2010)
```


Here's what Hannah Recht said to do to get the 16%...
```{r}
expenditures_overall <- state_public_health_agencies %>% filter(!(state_code %in% c("MO", "MI", "TX", "WY"))) %>%
                group_by(year) %>%
                summarize(expenditures_infl = sum(expenditures_infl),
                                                                                                population = sum(population)) %>%
                filter(year %in% c(2010, 2018)) %>%
                mutate(expenditures_infl_per_capita = expenditures_infl/population)
```

Man, that makes a lot more sense. So here is NC... 

```{r}
CompiledLHDExpenditures %>% 
                group_by(year) %>%
                summarize(cum_expenditures = sum(expenditures),
                                                                                                cum_population = sum(population)) %>%
                filter(year %in% c(2010, 2018)) %>%
                mutate(cum_expenditures_per_capita = cum_expenditures/cum_population)

```



Local health spending in the counties where we collected data is only down 6%. BUT WHAT DO WE GET WHEN WE ADJUST FOR INFLATION AS WELL.

Although the population in these counties has increase 19%, health care expenditures haven't kept up with the pace. They increased less than 12%.

(Maybe that because there is more efficiency. We've seen that. )




```{r}
state_public_health_agencies %>% filter(state_code =="NC", year %in% c(2010, 2018)) %>%
                select(year, expenditures_infl_per_capita)
```
While expenditures per capita declined 16% in the United States, they fell 27% in North Carolina.


It's been left to local agencies to pick up the slack. Some have. Some haven't. But nobody really knows. The report for the first time ever tries to shine light on the local publich health spending in North Carolina.


```{r}
nc_county_by_year %>% 
  filter(!is.na(year2010)) %>% 
  mutate(pct_change = (year2018 - year2010) / year2010) %>%
  arrange(pct_change) 
```
WTF Wake County?
```{r}
CompiledLHDExpenditures %>%
  filter(county_name == 
           "Wake")
```

The budget just got slashed between 2012-2013. Nealry in half! -47% per capita!

Did that happen everywhere?

```{r}
nc_county_by_year %>% 
  select(county_name, year2012, year2013) %>% 
  mutate(pct_change = (year2013 - year2012) / year2012) %>%
  arrange(pct_change) 
```
Right next door in more rural Johnston County in the same year, you had a 25% increase.

In fact, over 2010-2018 Johnston increased per-capita spending by 58%.... more than any county but Meck. 

(25 down, 19 up.)

MECK dipped, too, but the rocketed back to see a 66% increase in per capita spending.



```{r}
nc_county_by_year %>% 
  filter(!is.na(year2010)) %>% 
  mutate(pct_change = (year2018 - year2010) / year2010) %>%
  arrange(year2010) 
```


In 2010, (Cant say this: only two counties spent less) on public health per person than Meck -- tiny Stanly and Burke counties. 


```{r}
nc_county_by_year %>% 
  filter(!is.na(year2010)) %>% 
  mutate(pct_change = (year2018 - year2010) / year2010) %>%
  arrange(year2018) 
```
I see moving bubble chart graphic here. Circles are sizes of counties. Population on the x axis. Per capita spending on the Y axis. 

What does the map of 2018 per capita spending look like?
What does the map of pct change per capita look like?
What does population change do to it?

```{r}
CompiledLHDExpenditures %>%
  filter(year %in% c(2010, 2018)) %>%
  pivot_wider(id_cols = county_name, names_from = year, values_from = population, names_prefix = "year") %>%
  mutate(pop_diff = year2018-year2010, pct_diff = (year2018-year2010) / year2010)  %>%
  mutate(change = case_when(pop_diff > 0 ~ "increase", 
                            pop_diff <=0 ~ "decrease")) %>%
  arrange(pct_diff)
```
10 counties decrease pop
1. Lenoir
2. M,T,W
3. Rockingham
4. Richmond
5. Cleveland
6. Yadkin
7. Hyde
8. Greene
9. Person
10. Alexander

Population Grew in NC about 10% during that time. These counties grew by less than 10%
1. Craven
2. Granville/Vance
3. Jones
4. Rowan
5. Burke***
6. Wayne
7. Avery, Mithcell, Yancey
8. Catawba
9. Swain
10. Madison
11. Carteret
12. Stanly*** 
13. Lee
14. Dare
15. Trans.
16. Pitt
17. Gaston
18. Forsyth
19. Lincoln
20. Orange
21. Jackson
22. Guilford
23. Henderson

GREATER OR EQUAL STATEWIDE RATE
1. Iredell
2. Franklin
3. Moore
4. Cabarrus
5. Harnett
6. Union
7. Chatham
8. Johnston
9. Meck** 
10. Wake** 
11. Brunswick








