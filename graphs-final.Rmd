 ---
title: "Final Graphs"
author: "Rachel Crumpler"
date: "11/18/2020"
output: html_document
---

Loading data
```{r}

library(gsheet)
CompiledLHDExpenditures <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1Zc10pam92Y1218F90eXn9ri7-a4GQI1vhzING33nNSI/edit#gid=0")
```

Loading packages
```{r}
library("dplyr")
library("tidyverse")
library("ggplot2")
library("hrbrthemes")
library("plotly")
library("viridis")
library("scales")
library("tigris")
library("tmap")
```


LOLLIPOP CHART SHOWING COUNTIES THAT HAVE INCREASED IN PER CAPITA SPENDING VS. DECREASED (using inflation adjusted numbers)

```{r}
infl_nc_county_by_year <- infl_CompiledLHDExpenditures %>%
  filter(year >=2010, year<=2018) %>%
  pivot_wider(id_cols = county_name, names_from = year, values_from = expenditures_infl_per_capita, names_prefix = "year") %>%
  arrange(county_name)
```

```{r}
PerCapitaSpendingChange <- infl_nc_county_by_year %>% 
  filter(!is.na(year2010)) %>% 
  mutate(pct_change = (year2018 - year2010) / year2010) 
```

```{r}
ggplot(PerCapitaSpendingChange,
       aes(x=pct_change, y=fct_reorder(county_name, pct_change))) +
  geom_segment(
    aes(x=0,
        y=fct_reorder(county_name,pct_change),
        xend= pct_change,
        yend=fct_reorder(county_name, pct_change)),
    color="gray50")+
  geom_point(color="#1d91c0")+
  labs(x="Percent Change in Per Capita Spending", y="County Health Department", 
       title = "Percent Change in Per Capita Spending from 2010-2018",
       caption = "Data Source: County Finance Records (Did not receive data from 34 Health Departments)") +
  theme_minimal()+
   theme(panel.border = element_blank(),
        panel.grid.minor = element_blank()
   )
```

```{r}
ggsave("per-capita-spending-lollipop-chart.png")
```


LOLLIPOP CHART OF FTE CHANGE PER HEALTH DEPARTMENT FROM 2007 to 2017


```{r}
library(gsheet)
FTE_change_revised_names <- gsheet2tbl(
"https://docs.google.com/spreadsheets/d/1sQJlt7b6pTlsrSvPf4kN9E6mBDANDmPt4TozzTR_U0U/edit#gid=0")
```

```{r}
ggplot(FTE_change_revised_names,
       aes(x=pct_change, y=fct_reorder(lhd_name, pct_change))) +
  geom_segment(
    aes(x=0,
        y=fct_reorder(lhd_name,pct_change),
        xend= pct_change,
        yend=fct_reorder(lhd_name, pct_change)),
    color="gray50")+
  geom_point(color="#1d91c0")+
  labs(x="Percent Change in FTEs", y="County Health Department", 
       title = "Percent Change in Number of FTEs from 2007-2017",
       caption = "Data Source: KHN FTE Dataset") +
  theme_minimal()+
   theme(panel.border = element_blank(),
        panel.grid.minor = element_blank()
   )
```
```{r}
ggsave("FTE-change-lollipop-chart.png", width= 7, height = 10)
```

# Ignore these chunks. They just show before and after name change
```{r}
#nc_fte_change <- 
  local_health_departments_detail %>%
  filter(state_code == "NC", year %in% c(2007, 2017))%>%
  pivot_wider(id_cols = lhd_name, names_prefix = "year", names_from = year, values_from = fte) %>%
  mutate(change = year2017 - year2007, pct_change = (year2017 - year2007)/ year2007 ) %>%
  arrange(desc(pct_change))

```

```{r}
ggplot(nc_fte_change,
       aes(x=pct_change, y=fct_reorder(lhd_name, pct_change)
           )
       )+
  geom_segment(
    aes(x=0,
        y=fct_reorder(lhd_name,pct_change),
        xend= pct_change,
        yend=fct_reorder(lhd_name, pct_change)),
    color="gray50")+
  geom_point(color="#1d91c0")+
  labs(x="Percent Change in FTEs", y="County Health Department", 
       title = "Percent Change in Number of FTEs from 2007-2017",
       caption = "Data Source: KHN FTE Dataset") +
  theme_minimal()+
   theme(panel.border = element_blank(),
        panel.grid.minor = element_blank()
   )
  
```

CHANGE IN PER CAPITA FOR MECK, WAKE, UNION, JOHNSTON
- Width of lines = population
```{r}
MeckWakeUnionJohnston <- CompiledLHDExpenditures %>%
  filter(county_name %in% c("Mecklenburg", "Wake", "Union", "Johnston"), year >=2010, year<=2018)
```


```{r}
ggplotly(
ggplot(MeckWakeUnionJohnston) +
  geom_line(mapping = aes(x = year, y = per_capita_spending, color = county_name)) +
  labs(x = "Year", y = "Per Capita Spending", title = "Changes in Health Department Spending per Capita from 2010-2018", color = "County", caption = "Data Source: County Finance Records") +
 scale_y_continuous(labels= scales::dollar_format())+
  theme_minimal() 
)
```

```{r}
infl_MeckWakeUnionJohnston <- infl_CompiledLHDExpenditures %>%
  filter(county_name %in% c("Mecklenburg", "Wake", "Union", "Johnston"), year >=2014, year<=2018)
```


```{r}
ggplotly(
ggplot(infl_MeckWakeUnionJohnston) +
  geom_line(mapping = aes(x = year, y = expenditures_infl_per_capita, color = county_name)) +
  labs(x = "Year", y = "Per Capita Spending", title = "Changes in Health Department Spending per Capita from 2014-2018", color = "County", caption = "Data Source: County Finance Records, adjusted for inflation") +
 scale_y_continuous(labels= scales::dollar_format())+
  theme_minimal() 
)
```




MAP THAT SHOWS COUNTIES
* name
* Pop change
* expenditure change
* FTE change
red = counties that increased pop, but decreased FTEs
yellow = increased pop, increased FTEs
green = increased FTEs and expenditures at faster rate than pop.


Creating map that colored in all counties we have data for â€” got it to work for the health districts

```{r}
library(gsheet)
MappingData <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1mT0-4-S5YwefLuejmb3GhSN4m5zniLuwzOdAXymOAfk/edit#gid=0")
```

Downloading shapefile of NC counties
```{r}

options(tigris_use_cache = TRUE)
nc_counties <- counties("NC")
```

Renaming column so name is consistent with health data column name so data frames can be joined
```{r}
nc_counties<- dplyr::rename(nc_counties, county_name = NAME) 
```

Merging shapefile and data
```{r}
# merge on common variable, here called 'key'
new_pct_capita_map <- left_join(nc_counties, MappingData, by="county_name")
```

Loading in the code of data frame with percent change column
```{r}
MappingData <- MappingData %>%
  filter(year %in% c('2010', '2018')) %>%
  pivot_wider(id_cols = -c(expenditures,population), names_from = year, values_from = per_capita_spending) %>%
  mutate(capita_spending_change= (`2018` - `2010`),
    pct_change = 100 * ((`2018` - `2010`)) / `2010`) %>%
  arrange(desc(pct_change))
```


Creating map showing per capita percent change
**Need help refining legend position and legend labeling--want them to be percents
**Need help refining pop ups
```{r}
tm_shape(new_pct_capita_map) +
  tm_fill("pct_change",title="Percent Change in Health Department Per Capita Spending from 2010-2018",palette="YlGnBu")  +
  tm_borders()
```

Line chart showing change in national per capita spending at state level and NC per capita spending at state level

```{r}
library(tidyverse)
state_per_capita <- read_csv("01-state-public-health-agencies.csv")
```

```{r}
#install.packages("gghighlight")
library(gghighlight)
```
```{r}
ggplot(state_per_capita, aes(x=year, y=expenditures_infl_per_capita, group = state_code, color = state_code)) +
  geom_line() + 
  scale_fill_viridis(discrete = TRUE) +
  scale_x_continuous(breaks=c(2014, 2015, 2016, 2017, 2018, 2019)) +
  scale_y_continuous(labels = dollar) +
  labs(title = "Per Capita Spending by State Public Health Agencies, 2014-2018", y = "Per Capita Spending", x = "Year", caption="Note: No data for 2011-2014, Source: https://github.com/khnews/2020-underfunded-under-threat-data/blob/master/data/01-state-public-health-agencies.csv") +
  theme_ipsum() +
  gghighlight(state_code == "NC") +
 coord_cartesian(xlim = c(2014, 2018), ylim = c(0, 200))
```


